name: PR Build and Pre-release

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    env:
      NUGET_SECRET: ${{ secrets.NUGETS }}
      GOOGLE_SECRET_B64: ${{ secrets.GOOGLE_SECRET }}
    steps:
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'ga'

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install .NET MAUI Workload
        run: |
          dotnet workload install maui --source https://api.nuget.org/v3/index.json || true
          dotnet workload update || true

      - name: Expose Google JSON to environment (no file)
        if: ${{ env.GOOGLE_SECRET_B64 != '' }}
        shell: powershell
        run: |
          if (-not $env:GOOGLE_SECRET_B64) {
            Write-Error 'Environment variable GOOGLE_SECRET_B64 is empty'
            exit 1
          }
          try {
            $decoded = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($env:GOOGLE_SECRET_B64))
          } catch {
            Write-Error 'Failed to decode base64 from environment variable GOOGLE_SECRET_B64'
            exit 1
          }

          $entry = "GOOGLE_APPLICATION_CREDENTIALS_JSON<<EOF`n$decoded`nEOF"
          Add-Content -Path $env:GITHUB_ENV -Value $entry -Encoding utf8
          Write-Host 'Google JSON decoded into environment variable GOOGLE_APPLICATION_CREDENTIALS_JSON'

          try {
            $json = $decoded | ConvertFrom-Json -ErrorAction Stop
          } catch {
            Write-Warning 'Decoded content is not valid JSON; skipping FIREBASE_* exports'
            exit 0
          }

          $firebaseAppId = $null
          $firebaseApiKey = $null
          $firebaseDatabaseUrl = $null
          $firebaseAuthDomain = $null
          $firebaseWebClientId = $null

          if ($json.client -and $json.client.Count -ge 1) {
            $client0 = $json.client[0]
            if ($client0.client_info -and $client0.client_info.mobilesdk_app_id) {
              $firebaseAppId = $client0.client_info.mobilesdk_app_id
            }
            if ($client0.api_key -and $client0.api_key.Count -ge 1 -and $client0.api_key[0].current_key) {
              $firebaseApiKey = $client0.api_key[0].current_key
            }
            if ($client0.oauth_client) {
              foreach ($oc in $client0.oauth_client) {
                if (-not $firebaseWebClientId -and $oc.client_id) {
                  $firebaseWebClientId = $oc.client_id
                  break
                }
              }
            }
          }

          if ($json.project_info) {
            if ($json.project_info.firebase_url) {
              $firebaseDatabaseUrl = $json.project_info.firebase_url
            }
            if ($json.project_info.project_id) {
              $firebaseAuthDomain = "$($json.project_info.project_id).firebaseapp.com"
            }
          }

          $envEntries = @()
          if ($firebaseAppId)    { $envEntries += "FIREBASE_APP_ID=$firebaseAppId" }
          if ($firebaseApiKey)   { $envEntries += "FIREBASE_API_KEY=$firebaseApiKey" }
          if ($firebaseDatabaseUrl) { $envEntries += "FIREBASE_DATABASE_URL=$firebaseDatabaseUrl" }
          if ($firebaseAuthDomain)  { $envEntries += "FIREBASE_AUTH_DOMAIN=$firebaseAuthDomain" }
          if ($firebaseWebClientId) { $envEntries += "FIREBASE_WEB_CLIENT_ID=$firebaseWebClientId" }

          if ($envEntries.Count -gt 0) {
            foreach ($e in $envEntries) {
              Add-Content -Path $env:GITHUB_ENV -Value $e -Encoding utf8
            }
            Write-Host 'FIREBASE_* environment variables exported'
          } else {
            Write-Host 'No FIREBASE_* values were found in google-services.json'
          }

      - name: Configure ephemeral NuGet (optional)
        shell: powershell
        run: |
          $tempConfig = Join-Path $env:RUNNER_TEMP 'nuget.temp.config'
          if ("${{ env.NUGET_SECRET }}") {
            New-Item -Path (Split-Path $tempConfig) -ItemType Directory -Force | Out-Null
            Set-Content -Path $tempConfig -Value '<configuration></configuration>' -Encoding utf8 -Force
            dotnet nuget add source "https://nuget.pkg.github.com/CommunityToolkit/index.json" --name CommunityToolkit --username "${{ github.actor }}" --password "${{ env.NUGET_SECRET }}" --store-password-in-clear-text --configfile $tempConfig
            dotnet nuget add source "https://api.nuget.org/v3/index.json" --name nuget.org --configfile $tempConfig | Out-Null
            Add-Content -Path $env:GITHUB_ENV -Value "NUGET_CONFIG=$tempConfig" -Encoding utf8
          } else {
            Add-Content -Path $env:GITHUB_ENV -Value "NUGET_CONFIG=" -Encoding utf8
          }

      - name: Restore Windows project
        shell: powershell
        run: |
          $proj = 'EpubReader/EpubReader.csproj'
          $tfm = 'net10.0-windows10.0.19041.0'
          
          if ($env:NUGET_CONFIG -and (Test-Path $env:NUGET_CONFIG)) {
           dotnet restore $proj --no-cache --configfile $env:NUGET_CONFIG `
            /p:TargetFramework=$tfm `
            /p:RuntimeIdentifiers=win-x64 `
            /p:TreatWarningsAsErrors=false `
            /p:WarningLevel=0
          } else {
            dotnet restore $proj --no-cache --configfile nuget.config `
              --source https://api.nuget.org/v3/index.json `
              /p:TargetFramework=$tfm `
              /p:TreatWarningsAsErrors=false `
              /p:RuntimeIdentifiers=win-x64
          }

      - name: Build Windows project
        shell: powershell
        run: |
          dotnet build EpubReader/EpubReader.csproj `
            -c Release `
            -f net10.0-windows10.0.19041.0 `
            -r win-x64 `
            --no-restore `
            --self-contained `
            /p:TreatWarningsAsErrors=false `
            /p:WarningLevel=0 `
            --disable-build-servers
      - name: Publish Windows app
        shell: powershell
        run: |
          dotnet publish EpubReader/EpubReader.csproj `
            -c Release `
            -f net10.0-windows10.0.19041.0 `
            -o artifacts/windows `
            --self-contained `
            /p:TreatWarningsAsErrors=false `
            /p:WarningLevel=0 || $true
      - name: Package Windows artifact
        run: |
          pwsh -Command "if (Test-Path artifacts/windows) { Compress-Archive -Path 'artifacts/windows/*' -DestinationPath 'windows-artifact.zip' -Force } else { Write-Host 'No windows artifacts found'; New-Item -ItemType File -Path 'windows-artifact.zip' -Force | Out-Null }"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifact
          path: windows-artifact.zip

  build-android:
    name: Build (Android)
    runs-on: ubuntu-latest
    env:
      NUGET_SECRET: ${{ secrets.NUGETS }}
      GOOGLE_SECRET_B64: ${{ secrets.GOOGLE_SECRET }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'
          architecture: 'x64'

      - name: Verify Java
        run: |
          java -version
          javac -version

      - name: Install workloads
        run: |
          dotnet workload install maui --source https://api.nuget.org/v3/index.json || true
          dotnet workload restore || true

      - name: Expose Google JSON to environment (no file)
        if: ${{ env.GOOGLE_SECRET_B64 != '' }}
        shell: pwsh
        run: |
          if (-not $env:GOOGLE_SECRET_B64) {
            Write-Error 'Environment variable GOOGLE_SECRET_B64 is empty'
            exit 1
          }
          try {
            $decoded = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($env:GOOGLE_SECRET_B64))
          } catch {
            Write-Error 'Failed to decode base64 from environment variable GOOGLE_SECRET_B64'
            exit 1
          }

          $entry = "GOOGLE_APPLICATION_CREDENTIALS_JSON<<EOF`n$decoded`nEOF"
          Add-Content -Path $env:GITHUB_ENV -Value $entry -Encoding utf8
          Write-Host 'Google JSON decoded into environment variable GOOGLE_APPLICATION_CREDENTIALS_JSON'

          try {
            $json = $decoded | ConvertFrom-Json -ErrorAction Stop
          } catch {
            Write-Warning 'Decoded content is not valid JSON; skipping FIREBASE_* exports'
            exit 0
          }

          $firebaseAppId = $null
          $firebaseApiKey = $null
          $firebaseDatabaseUrl = $null
          $firebaseAuthDomain = $null
          $firebaseWebClientId = $null

          if ($json.client -and $json.client.Count -ge 1) {
            $client0 = $json.client[0]
            if ($client0.client_info -and $client0.client_info.mobilesdk_app_id) {
              $firebaseAppId = $client0.client_info.mobilesdk_app_id
            }
            if ($client0.api_key -and $client0.api_key.Count -ge 1 -and $client0.api_key[0].current_key) {
              $firebaseApiKey = $client0.api_key[0].current_key
            }
            if ($client0.oauth_client) {
              foreach ($oc in $client0.oauth_client) {
                if (-not $firebaseWebClientId -and $oc.client_id) {
                  $firebaseWebClientId = $oc.client_id
                  break
                }
              }
            }
          }

          if ($json.project_info) {
            if ($json.project_info.firebase_url) {
              $firebaseDatabaseUrl = $json.project_info.firebase_url
            }
            if ($json.project_info.project_id) {
              $firebaseAuthDomain = "$($json.project_info.project_id).firebaseapp.com"
            }
          }

          $envEntries = @()
          if ($firebaseAppId)    { $envEntries += "FIREBASE_APP_ID=$firebaseAppId" }
          if ($firebaseApiKey)   { $envEntries += "FIREBASE_API_KEY=$firebaseApiKey" }
          if ($firebaseDatabaseUrl) { $envEntries += "FIREBASE_DATABASE_URL=$firebaseDatabaseUrl" }
          if ($firebaseAuthDomain)  { $envEntries += "FIREBASE_AUTH_DOMAIN=$firebaseAuthDomain" }
          if ($firebaseWebClientId) { $envEntries += "FIREBASE_WEB_CLIENT_ID=$firebaseWebClientId" }

          if ($envEntries.Count -gt 0) {
            foreach ($e in $envEntries) {
              Add-Content -Path $env:GITHUB_ENV -Value $e -Encoding utf8
            }
            Write-Host 'FIREBASE_* environment variables exported'
          } else {
            Write-Host 'No FIREBASE_* values were found in google-services.json'
          }

      - name: Configure ephemeral NuGet (optional)
        shell: pwsh
        run: |
          $tempConfig = Join-Path $env:RUNNER_TEMP 'nuget.temp.config'
          if ("${{ env.NUGET_SECRET }}") {
            New-Item -Path (Split-Path $tempConfig) -ItemType Directory -Force | Out-Null
            Set-Content -Path $tempConfig -Value '<configuration></configuration>' -Encoding utf8 -Force
            dotnet nuget add source "https://nuget.pkg.github.com/CommunityToolkit/index.json" --name CommunityToolkit --username "${{ github.actor }}" --password "${{ env.NUGET_SECRET }}" --store-password-in-clear-text --configfile $tempConfig
            dotnet nuget add source "https://api.nuget.org/v3/index.json" --name nuget.org --configfile $tempConfig | Out-Null
            Add-Content -Path $env:GITHUB_ENV -Value "NUGET_CONFIG=$tempConfig" -Encoding utf8
          } else {
            Add-Content -Path $env:GITHUB_ENV -Value "NUGET_CONFIG=" -Encoding utf8
          }

      - name: Restore (Android project only)
        shell: pwsh
        run: |
          $proj = 'EpubReader/EpubReader.csproj'
          $tfm = 'net10.0-android'
          if ($env:NUGET_CONFIG -and (Test-Path $env:NUGET_CONFIG)) {
            dotnet restore $proj --no-cache --configfile $env:NUGET_CONFIG /p:TargetFramework=$tfm
          } else {
            dotnet restore $proj --no-cache --configfile nuget.config --source https://api.nuget.org/v3/index.json /p:TargetFramework=$tfm
          }

      - name: Build (Android project only)
        run: dotnet build EpubReader/EpubReader.csproj -c Release -f net10.0-android --no-restore

      - name: Publish Android app
        run: |
          dotnet publish EpubReader/EpubReader.csproj -c Release -f net10.0-android -o artifacts/android || true

      - name: Archive Android artifact
        run: |
          if [ -d artifacts/android ]; then zip -r android-artifact.zip artifacts/android || true; else touch android-artifact.zip; fi

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-artifact
          path: android-artifact.zip

  create-pre-release:
    name: Create Pre-release and Attach Artifacts
    runs-on: ubuntu-latest
    needs: [build-windows, build-android]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Check for windows artifact
        id: check_windows
        run: |
          if [ -f artifacts/windows-artifact/windows-artifact.zip ]; then echo "present=true" >> $GITHUB_OUTPUT; else echo "present=false" >> $GITHUB_OUTPUT; fi

      - name: Check for android artifact
        id: check_android
        run: |
          if [ -f artifacts/android-artifact/android-artifact.zip ]; then echo "present=true" >> $GITHUB_OUTPUT; else echo "present=false" >> $GITHUB_OUTPUT; fi

      - name: Generate changelog
        id: changelog
        run: |
          base_sha="${{ github.event.pull_request.base.sha }}"
          head_sha="${{ github.event.pull_request.head.sha }}"
          git fetch --no-tags origin ${{ github.event.pull_request.base.ref }} || true
          git log --pretty=format:"- %s (%an)" $base_sha..$head_sha > pr-changelog.txt || true
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat pr-changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create pre-release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: pr-${{ github.event.pull_request.number }}-${{ github.event.pull_request.head.sha }}
          release_name: "PR #${{ github.event.pull_request.number }} release"
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ github.event.pull_request.merged != true }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows asset to release
        if: steps.check_windows.outputs.present == 'true'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/windows-artifact/windows-artifact.zip
          asset_name: EpubReader-Windows-PR-${{ github.event.pull_request.number }}.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Android asset to release
        if: steps.check_android.outputs.present == 'true'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/android-artifact/android-artifact.zip
          asset_name: EpubReader-Android-PR-${{ github.event.pull_request.number }}.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}