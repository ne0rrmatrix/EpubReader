name: SonarQube
on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  build:
    name: Build and analyze
    env:
      SECRET: ${{ secrets.SONAR_TOKEN }}
      GOOGLE_SECRET_B64: ${{ secrets.GOOGLE_SECRET }}
    runs-on: windows-latest
    steps:
      - uses: actions/setup-dotnet@v5
        with:
                    dotnet-version: '10.0.x'
                    dotnet-quality: 'ga'

      -   uses: actions/setup-java@v5
          with:
                    distribution: 'microsoft'
                    java-version: '21'

      -   name: Install .NET MAUI Workload
          run: |
                    dotnet workload install maui
                    dotnet workload update
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      - name: Expose Google JSON to environment (no file)
        if: ${{ secrets.GOOGLE_SECRET != '' }}
        shell: powershell
        run: |
          if (-not $env:GOOGLE_SECRET_B64) {
            Write-Error 'Environment variable GOOGLE_SECRET_B64 is empty'
            exit 1
          }
          try {
            $decoded = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($env:GOOGLE_SECRET_B64))
          } catch {
            Write-Error 'Failed to decode base64 from environment variable GOOGLE_SECRET_B64'
            exit 1
          }
          $entry = "GOOGLE_APPLICATION_CREDENTIALS_JSON<<EOF`n$decoded`nEOF"
          Add-Content -Path $env:GITHUB_ENV -Value $entry -Encoding utf8
          Write-Host 'Google JSON decoded into environment variable GOOGLE_APPLICATION_CREDENTIALS_JSON'

      - name: Cache SonarQube Cloud packages
        uses: actions/cache@v4
        with:
          path: ~\sonar\cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Cache SonarQube Cloud scanner
        id: cache-sonar-scanner
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}\scanner
          key: ${{ runner.os }}-sonar-scanner
          restore-keys: ${{ runner.os }}-sonar-scanner
      - name: Install SonarQube Cloud scanner
        if: steps.cache-sonar-scanner.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          New-Item -Path ${{ runner.temp }}\scanner -ItemType Directory
          dotnet tool update dotnet-sonarscanner --tool-path ${{ runner.temp }}\scanner
      - name: Build and analyze
        shell: powershell
        run: |
          ${{ runner.temp }}\scanner\dotnet-sonarscanner begin /k:"ne0rrmatrix_EpubReader" /o:"ne0rrmatrix" /d:sonar.token="$SECRET"
           dotnet restore EpubReader/EpubReader.csproj
           dotnet build EpubReader/EpubReader.csproj -c:Debug
          ${{ runner.temp }}\scanner\dotnet-sonarscanner end /d:sonar.token="$SECRET"
