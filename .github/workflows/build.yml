name: Build

on:
  push:
    branches: [ master ]
    tags: [ '*' ]

env:
  LATEST_NET_VERSION: '10.0.x'

jobs:
  decode-google-json:
    name: Decode Google JSON (if provided)
    runs-on: ubuntu-latest
    env:
      GOOGLE_SECRET_B64: ${{ secrets.GOOGLE_SECRET }}
    outputs:
      firebase_api_key: ${{ steps.parse.outputs.firebase_api_key }}
      firebase_database_url: ${{ steps.parse.outputs.firebase_database_url }}
      firebase_auth_domain: ${{ steps.parse.outputs.firebase_auth_domain }}
      firebase_app_id: ${{ steps.parse.outputs.firebase_app_id }}
      firebase_web_client_id: ${{ steps.parse.outputs.firebase_web_client_id }}
    steps:
      - name: Check for secret
        id: check
        run: |
          if [ -z "$GOOGLE_SECRET_B64" ]; then
            echo "no_secret=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "no_secret=false" >> $GITHUB_OUTPUT

      - name: Decode and save google-services.json
        id: decode
        if: steps.check.outputs.no_secret == 'false'
        run: |
          echo "$GOOGLE_SECRET_B64" | base64 --decode > google-services.json

      - name: Parse FIREBASE_* values
        id: parse
        if: steps.check.outputs.no_secret == 'false'
        run: |
          firebase_api_key=$(jq -r '.client[0].api_key[0].current_key // empty' google-services.json)
          firebase_database_url=$(jq -r '.project_info.firebase_url // empty' google-services.json)
          firebase_app_id=$(jq -r '.client[0].client_info.mobilesdk_app_id // empty' google-services.json)
          firebase_auth_domain=$(jq -r 'if .project_info.project_id then (.project_info.project_id + ".firebaseapp.com") else "" end' google-services.json)
          firebase_web_client_id=$(jq -r '.client[0].oauth_client[0].client_id // empty' google-services.json)
          echo "firebase_api_key=$firebase_api_key" >> $GITHUB_OUTPUT
          echo "firebase_database_url=$firebase_database_url" >> $GITHUB_OUTPUT
          echo "firebase_app_id=$firebase_app_id" >> $GITHUB_OUTPUT
          echo "firebase_auth_domain=$firebase_auth_domain" >> $GITHUB_OUTPUT
          echo "firebase_web_client_id=$firebase_web_client_id" >> $GITHUB_OUTPUT

      - name: Upload decoded google-services.json
        if: steps.check.outputs.no_secret == 'false'
        uses: actions/upload-artifact@v6
        with:
          name: google-services-json
          path: google-services.json

  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    env:
      NUGET_SECRET: ${{ secrets.NUGETS }}
      GOOGLE_SECRET_B64: ${{ secrets.GOOGLE_SECRET }}
    steps:
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'ga'

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'microsoft'
          java-version: '21'

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install .NET MAUI Workload
        run: |
          dotnet workload install maui --source https://api.nuget.org/v3/index.json || true
          dotnet workload update || true

      - name: Download decoded google-services.json (if produced)
        uses: actions/download-artifact@v7
        with:
          name: google-services-json
          path: decoded-google

      - name: Import GOOGLE_APPLICATION_CREDENTIALS_JSON (if artifact present)
        shell: powershell
        run: |
          $p = 'decoded-google/google-services.json'
          if (Test-Path $p) {
            $decoded = Get-Content -Raw -Path $p
            $entry = "GOOGLE_APPLICATION_CREDENTIALS_JSON<<EOF`n$decoded`nEOF"
            Add-Content -Path $env:GITHUB_ENV -Value $entry -Encoding utf8
            Write-Host 'Google JSON decoded into environment variable GOOGLE_APPLICATION_CREDENTIALS_JSON'
          } else {
            Write-Host 'No decoded google-services.json artifact found; skipping import'
          }

      - name: Configure ephemeral NuGet (optional)
        shell: powershell
        run: |
          $tempConfig = Join-Path $env:RUNNER_TEMP 'nuget.temp.config'
          if ("${{ env.NUGET_SECRET }}") {
            New-Item -Path (Split-Path $tempConfig) -ItemType Directory -Force | Out-Null
            Set-Content -Path $tempConfig -Value '<configuration></configuration>' -Encoding utf8 -Force
            dotnet nuget add source "https://nuget.pkg.github.com/CommunityToolkit/index.json" --name CommunityToolkit --username "${{ github.actor }}" --password "${{ env.NUGET_SECRET }}" --store-password-in-clear-text --configfile $tempConfig
            dotnet nuget add source "https://api.nuget.org/v3/index.json" --name nuget.org --configfile $tempConfig | Out-Null
            Add-Content -Path $env:GITHUB_ENV -Value "NUGET_CONFIG=$tempConfig" -Encoding utf8
          } else {
            Add-Content -Path $env:GITHUB_ENV -Value "NUGET_CONFIG=" -Encoding utf8
          }

      - name: Restore Windows project
        shell: powershell
        run: |
          $proj = 'EpubReader/EpubReader.csproj'
          $tfm = 'net10.0-windows10.0.19041.0'
          
          if ($env:NUGET_CONFIG -and (Test-Path $env:NUGET_CONFIG)) {
           dotnet restore $proj --no-cache --configfile $env:NUGET_CONFIG `
            /p:TargetFramework=$tfm `
            /p:RuntimeIdentifiers=win-x64 `
            /p:TreatWarningsAsErrors=false `
            /p:WarningLevel=0
          } else {
            dotnet restore $proj --no-cache --configfile nuget.config `
              --source https://api.nuget.org/v3/index.json `
              /p:TargetFramework=$tfm `
              /p:TreatWarningsAsErrors=false `
              /p:RuntimeIdentifiers=win-x64
          }
      - name: Clean build artifacts
        shell: pwsh
        run: |
         $objPath = "EpubReader/obj"
         # Ensure the directory structure exists
         New-Item -ItemType Directory -Path "$objPath/GeneratedFiles" -Force | Out-Null
      
      - name: Build Windows project
        shell: powershell
        run: |
          dotnet build EpubReader/EpubReader.csproj `
            -c Release `
            -f net10.0-windows10.0.19041.0 `
            -r win-x64 `
            --no-restore `
            --self-contained `
            /p:TreatWarningsAsErrors=false `
            /p:WarningLevel=0 `

      - name: Publish Windows app
        shell: powershell
        run: |
          dotnet publish EpubReader/EpubReader.csproj `
            -c Release `
            -f net10.0-windows10.0.19041.0 `
            -o artifacts/windows `
            --self-contained `
            /p:TreatWarningsAsErrors=false `
            /p:WarningLevel=0 `
      - name: Package Windows artifact
        run: |
          pwsh -Command "if (Test-Path artifacts/windows) { Compress-Archive -Path 'artifacts/windows/*' -DestinationPath 'windows-artifact.zip' -Force } else { Write-Host 'No windows artifacts found'; New-Item -ItemType File -Path 'windows-artifact.zip' -Force | Out-Null }"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v6
        with:
          name: windows-artifact
          path: windows-artifact.zip

  build-android:
    name: Build (Android)
    needs: decode-google-json
    runs-on: ubuntu-latest
    env:
      NUGET_SECRET: ${{ secrets.NUGETS }}
      ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      FIREBASE_API_KEY: ${{ needs.decode-google-json.outputs.firebase_api_key }}
      FIREBASE_DATABASE_URL: ${{ needs.decode-google-json.outputs.firebase_database_url }}
      FIREBASE_AUTH_DOMAIN: ${{ needs.decode-google-json.outputs.firebase_auth_domain }}
      FIREBASE_APP_ID: ${{ needs.decode-google-json.outputs.firebase_app_id }}
      FIREBASE_WEB_CLIENT_ID: ${{ needs.decode-google-json.outputs.firebase_web_client_id }}
    steps:
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'ga'

      - uses: actions/setup-java@v5
        with:
          distribution: 'microsoft'
          java-version: '21'

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install workloads
        run: |
          dotnet workload install maui --source https://api.nuget.org/v3/index.json || true
          dotnet workload restore || true

      - name: Download decoded google-services.json (if produced)
        uses: actions/download-artifact@v7
        with:
          name: google-services-json
          path: decoded-google

      - name: Import GOOGLE_APPLICATION_CREDENTIALS_JSON (if artifact present)
        shell: pwsh
        run: |
          $p = 'decoded-google/google-services.json'
          if (Test-Path $p) {
            $decoded = Get-Content -Raw -Path $p
            $entry = "GOOGLE_APPLICATION_CREDENTIALS_JSON<<EOF`n$decoded`nEOF"
            Add-Content -Path $env:GITHUB_ENV -Value $entry -Encoding utf8
            Write-Host 'Google JSON decoded into environment variable GOOGLE_APPLICATION_CREDENTIALS_JSON'
          } else {
            Write-Host 'No decoded google-services.json artifact found; skipping import'
          }

      - name: Configure ephemeral NuGet (optional)
        shell: pwsh
        run: |
          $tempConfig = Join-Path $env:RUNNER_TEMP 'nuget.temp.config'
          if ("${{ env.NUGET_SECRET }}") {
            New-Item -Path (Split-Path $tempConfig) -ItemType Directory -Force | Out-Null
            Set-Content -Path $tempConfig -Value '<configuration></configuration>' -Encoding utf8 -Force
            dotnet nuget add source "https://nuget.pkg.github.com/CommunityToolkit/index.json" --name CommunityToolkit --username "${{ github.actor }}" --password "${{ env.NUGET_SECRET }}" --store-password-in-clear-text --configfile $tempConfig
            dotnet nuget add source "https://api.nuget.org/v3/index.json" --name nuget.org --configfile $tempConfig | Out-Null
            Add-Content -Path $env:GITHUB_ENV -Value "NUGET_CONFIG=$tempConfig" -Encoding utf8
          } else {
            Add-Content -Path $env:GITHUB_ENV -Value "NUGET_CONFIG=" -Encoding utf8
          }

      - name: Restore (Android project only)
        shell: pwsh
        run: |
          $proj = 'EpubReader/EpubReader.csproj'
          $tfm = 'net10.0-android'
          if ($env:NUGET_CONFIG -and (Test-Path $env:NUGET_CONFIG)) {
            dotnet restore $proj --no-cache --configfile $env:NUGET_CONFIG /p:TargetFramework=$tfm
          } else {
            dotnet restore $proj --no-cache --configfile nuget.config --source https://api.nuget.org/v3/index.json /p:TargetFramework=$tfm
          }

      - name: Build (Android project only)
        run: dotnet build EpubReader/EpubReader.csproj -c Release -f net10.0-android --no-restore

      - name: Restore Android keystore and publish (signed if env present)
        run: |
          if [ -n "$ANDROID_KEYSTORE_B64" ]; then
            echo "Decoding Android keystore from env"
            mkdir -p EpubReader
            printf '%s' "$ANDROID_KEYSTORE_B64" | base64 --decode > EpubReader/EpubReader.keystore
            dotnet publish EpubReader/EpubReader.csproj -c Release -f net10.0-android --no-restore -o artifacts/android \
              /p:AndroidKeyStore=true \
              /p:AndroidSigningKeyStore="$(pwd)/EpubReader/EpubReader.keystore" \
              /p:AndroidSigningStorePass="$ANDROID_KEYSTORE_PASSWORD" \
              /p:AndroidSigningKeyAlias="$ANDROID_KEY_ALIAS" \
              /p:AndroidSigningKeyPass="$ANDROID_KEY_PASSWORD" || true
            rm -f EpubReader/EpubReader.keystore || true
          else
            echo "No ANDROID_KEYSTORE_B64 env found â€” publishing unsigned APK/AAB"
            dotnet publish EpubReader/EpubReader.csproj -c Release -f net10.0-android -o artifacts/android || true
          fi

      - name: Archive Android artifact
        run: |
          if [ -d artifacts/android ]; then zip -r android-artifact.zip artifacts/android || true; else touch android-artifact.zip; fi

      - name: Upload Android artifact
        uses: actions/upload-artifact@v6
        with:
          name: android-artifact
          path: android-artifact.zip

  create-release:
    name: Create Release and Attach Artifacts
    runs-on: ubuntu-latest
    needs: [build-windows, build-android]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Generate changelog and write body file
        run: |
          tag_ref=${GITHUB_REF##*/}
          echo "Generating changelog for $tag_ref"
          git fetch --no-tags --prune --unshallow || true
          git log --pretty=format:"- %s (%an)" -n 200 $GITHUB_SHA > release-changelog.txt || true
          printf "# Release %s\n\n" "$tag_ref" > body.md
          cat release-changelog.txt >> body.md || true

      - name: Create release and upload assets
        uses: ncipollo/release-action@5f55df31e10e67a2ef62ea8f3fa1b926cee6f8b1
        with:
          tag: ${GITHUB_REF##*/}
          name: "Release ${GITHUB_REF##*/}"
          bodyFile: body.md
          draft: false
          prerelease: false
          artifacts: "artifacts/windows-artifact/windows-artifact.zip,artifacts/android-artifact/android-artifact.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
